<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head th:replace="~{fragments/base :: head(styles='/css/form-styles.css')}"></head>
<body>
    <header th:replace="~{fragments/base :: headerCompleto}"></header>
    <main class="container my-5">
        <h2>Centro de Asignación de Pedidos</h2>
        <p class="text-muted">Lista de todos los pedidos y el personal que los atiende.</p>

        <div class="card card-body mb-4">
            <form th:action="@{/atender}" method="GET" class="d-flex gap-2">
                <input type="text" name="q" class="form-control" placeholder="Buscar por nombre de empleado...">
                <button type="submit" class="btn btn-info">Buscar</button>
                <a th:href="@{/atender}" class="btn btn-secondary">Limpiar</a>
            </form>
        </div>

        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
        
        <table class="table table-hover table-bordered shadow-sm mt-4">
            <thead class="table-dark">
                <tr>
                    <th># Pedido</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Clave Empleado</th>
                    <th>Empleados Asignados</th>
                    <th>Puesto</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="p : ${pedidos}">
                    <td th:text="${p.idPedido}"></td>
                    <td th:text="${p.cliente != null ? p.cliente.nombre : 'N/A'}"></td>
                    <td th:text="${#temporals.format(p.fecha, 'dd-MM-yyyy')}"></td>
                    
                    <td>
                        <div th:if="${p.empleadosQueAtienden.isEmpty()}">--</div>
                        <div th:each="emp : ${p.empleadosQueAtienden}">
                            <span th:text="${emp.clave}" class="fw-bold d-block"></span>
                        </div>
                    </td>
                    <td>
                        <div th:if="${p.empleadosQueAtienden.isEmpty()}" class="text-danger">-- Sin Asignar --</div>
                        <div th:each="emp : ${p.empleadosQueAtienden}">
                            <span th:text="${emp.nombreCompleto}" class="d-block"></span>
                        </div>
                    </td>
                    <td>
                        <div th:if="${p.empleadosQueAtienden.isEmpty()}">--</div>
                        <div th:each="emp : ${p.empleadosQueAtienden}">
                            <span th:text="${emp.puesto}" class="d-block"></span>
                        </div>
                    </td>
                    
                    <td>
                        <a href="#" class="btn btn-info btn-sm"
                           data-bs-toggle="modal" data-bs-target="#detallePedidoModal"
                           th:attr="data-pedido-id=${p.idPedido},
                                    data-pedido-fecha=${#temporals.format(p.fecha,'dd-MM-yyyy')},
                                    data-pedido-cliente-id=${p.cliente != null ? p.cliente.id : 'N/A'}, 
                                    data-pedido-cliente=${p.cliente != null ? p.cliente.nombre + ' ' + p.cliente.apellidos : 'N/A'},
                                    data-pedido-total=${#numbers.formatDecimal(p.total,1,2)},
                                    data-pedido-detalles=${objectMapper.writeValueAsString(p.detalles)}">
                            Ver Detalle
                        </a>
                        
                        <a th:href="@{/atender/asignar/{idPedido}(idPedido=${p.idPedido})}" class="btn btn-warning btn-sm mt-1">
                            Asignar
                        </a>
                        
                        <a th:if="${!p.empleadosQueAtienden.isEmpty()}" 
                           th:href="@{/atender/cancelar/{idPedido}(idPedido=${p.idPedido})}" 
                           class="btn btn-secondary btn-sm mt-1" 
                           onclick="return confirm('¿Quitar TODAS las asignaciones de este pedido?');">
                            Cancelar Asig.
                        </a>
                    </td>
                </tr>
            </tbody>
        </table>
    </main>

    <div class="modal fade" id="detallePedidoModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detalle del Pedido #<span id="modal-pedido-id"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p><strong>Cliente:</strong> <span id="modal-pedido-cliente"></span></p>
            <p><strong>Fecha:</strong> <span id="modal-pedido-fecha"></span></p>
            <hr>
            <h6>Productos:</h6>
            <table class="table">
              <thead>
                <tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Subtotal</th></tr>
              </thead>
              <tbody id="modal-detalles-body"></tbody>
            </table>
            <h4 class="text-end mt-3">Total: $<span id="modal-pedido-total"></span></h4>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
    <footer th:replace="~{fragments/base :: footer}"></footer>

    <script th:inline="none">
      const detalleModal = document.getElementById('detallePedidoModal');
      if (detalleModal) {
        detalleModal.addEventListener('show.bs.modal', event => {
          const button = event.relatedTarget;
          const pedidoId = button.getAttribute('data-pedido-id') || '';
          const pedidoFecha = button.getAttribute('data-pedido-fecha') || '';
          const pedidoCliente = button.getAttribute('data-pedido-cliente') || 'N/A';
          const pedidoTotal = button.getAttribute('data-pedido-total') || '0.00';
          const detallesRaw = button.getAttribute('data-pedido-detalles') || '[]';
          let pedidoDetalles = [];
          try { pedidoDetalles = JSON.parse(detallesRaw); } catch(e) { console.error('Error parsing JSON:', e); }
    
          detalleModal.querySelector('#modal-pedido-id').textContent = pedidoId;
          detalleModal.querySelector('#modal-pedido-cliente').textContent = pedidoCliente;
          detalleModal.querySelector('#modal-pedido-fecha').textContent = pedidoFecha;
          detalleModal.querySelector('#modal-pedido-total').textContent = pedidoTotal;
    
          const tbody = detalleModal.querySelector('#modal-detalles-body');
          tbody.innerHTML = '';
    
          if (pedidoDetalles.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Sin detalles</td></tr>';
            return;
          }
    
          pedidoDetalles.forEach(detalle => {
            const nombre = detalle.producto?.nombre || 'N/D';
            const cantidad = detalle.cantidad || 0;
            const precio = detalle.precio || 0;
            const subtotal = cantidad * precio;
            
            const row = `<tr>
              <td>${nombre}</td>
              <td>${cantidad}</td>
              <td>$${precio.toFixed(2)}</td>
              <td>$${subtotal.toFixed(2)}</td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
          });
        });
      }
    </script>
    </body>
</html>